<div class="quote-form-section">
  <h1>Create a New Quote</h1>
  <app-alert *ngIf="alertMessage" [message]="alertMessage" [type]="alertType"></app-alert>

  <form [formGroup]="quoteForm" *ngIf="step === 1" (ngSubmit)="nextStep()" class="quote-form">
    <div class="form-group">
      <label>Business Name</label>
      <input type="text" formControlName="businessName" />
      <div class="text-danger"
        *ngIf="quoteForm.controls['businessName'].touched && quoteForm.controls['businessName'].errors?.['required']">
        Business Name is required.
      </div>
    </div>

    <div class="form-group">
      <label>GST Number</label>
      <input type="text" formControlName="gstNo" />
      <div class="text-danger"
        *ngIf="quoteForm.controls['gstNo'].touched && (quoteForm.controls['gstNo'].errors?.['minlength'] || quoteForm.controls['gstNo'].errors?.['maxlength'])">
        The length must be exactly 15 characters.
      </div>
    </div>

    <div class="form-group">
      <label>Annual Turnover</label>
      <input type="number" formControlName="annualTurnover" />
      <div class="text-danger"
        *ngIf="quoteForm.controls['annualTurnover'].touched && quoteForm.controls['annualTurnover'].errors?.['min']">
        The turnover must be at least ₹10,000.
      </div>
      <div class="text-danger"
        *ngIf="quoteForm.controls['annualTurnover'].touched && quoteForm.controls['annualTurnover'].errors?.['required']">
        Please enter a turnover amount.
      </div>
    </div>

    <div class="form-group">
      <label>Business Type</label>
      <select formControlName="businessType">
        <option value="Retail">Retail</option>
        <option value="Manufacturing">Manufacturing</option>
        <option value="High Risk">High Risk</option>
      </select>
    </div>

    <!-- <button type="submit" class="submit-button" [disabled]="quoteForm.invalid">Next</button> -->
    <button type="button" class="submit-button" (click)="nextStep()">Next</button>
  </form>

  <form [formGroup]="quoteForm" *ngIf="step === 2" (ngSubmit)="nextStep()" class="quote-form">
    <div class="form-group">
      <label>Property Value</label>
      <input type="number" formControlName="propertyValue" />
      <div class="text-danger"
        *ngIf="quoteForm.controls['propertyValue'].touched && quoteForm.controls['propertyValue'].errors?.['required']">
        Property Value is required.
      </div>
    </div>

    <div class="form-group">
      <label>Ownership Type</label>
      <select formControlName="ownershipType">
        <option value="Owned">Owned</option>
        <option value="Rented">Rented</option>
      </select>
    </div>

    <div class="form-group">
      <label>Location Type</label>
      <select formControlName="locationType">
        <option value="Urban">Urban</option>
        <option value="Suburban">Suburban</option>
        <option value="Rural">Rural</option>
      </select>
    </div>

    <button type="button" class="submit-button" (click)="prevStep()">Back</button>
    <!-- <button type="submit" class="submit-button" [disabled]="quoteForm.invalid">Next</button> -->
    <button type="button" class="submit-button" (click)="nextStep()">Next</button>
  </form>

  <form [formGroup]="quoteForm" *ngIf="step === 3" (ngSubmit)="submitQuote()" class="quote-form">
    <div class="form-group">
      <label>Security Systems</label>
      <input type="text" formControlName="securitySystem" />
      <div class="text-danger"
        *ngIf="quoteForm.controls['securitySystem'].touched && quoteForm.controls['securitySystem'].errors?.['required']">
        Security Systems is required. If unsure, simply enter 'Decent' as the default value.
      </div>
    </div>

    <div class="form-group">
      <label>Previous Claims</label>
      <input type="text" formControlName="previousClaims" />
      <div class="text-danger"
        *ngIf="quoteForm.controls['previousClaims'].touched && quoteForm.controls['previousClaims'].errors?.['required']">
        Previous Claims is required. If unsure, simply enter 'None' as the default value.
      </div>
    </div>

    <div class="form-group">
      <label>Preferred Plan</label>
      <select formControlName="planType">
        <option value="Normal">Normal - 0.5%</option>
        <option value="Gold">Gold - 1%</option>
        <option value="Premium">Premium - 1.5%</option>
      </select>
    </div>

    <button type="button" class="submit-button" (click)="prevStep()">Back</button>
    <button type="submit" class="submit-button" [disabled]="quoteForm.invalid">Submit</button>
  </form>
  <div *ngIf="submittedQuote" class="quote-summary">
    <h3>Quote Generated Successfully!</h3>
    <p><strong>Business Name:</strong> {{ submittedQuote.businessName }}</p>
    <p><strong>Plan:</strong> {{ submittedQuote.planType }}</p>

    <!-- Quote Breakdown Table -->
    <table class="quote-table">
      <thead>
        <tr>
          <th>Factor</th>
          <th>Percentage/Adjustment</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Base Rate</td>
          <td>{{  baseRate ? baseRate * 100 : 0 }}%</td>
        </tr>
        <tr>
          <td>Business Type Adjustment</td>
          <td>{{ businessTypeRate ? businessTypeRate * 100 : 0 }}%</td>
        </tr>
        <tr>
          <td>Location Adjustment</td>
          <td>{{ locationRate ? locationRate * 100 : 0}}%</td>
        </tr>
        <tr>
          <td><strong>Total Adjustment</strong></td>
          <td><strong>{{ finalRate ? finalRate * 100 : 0  }}%</strong></td>
        </tr>
        <tr>
          <td>Property Value</td>
          <td>Rs {{ propertyRate | number:'1.3-3'}}</td>
        </tr>
      </tbody>
    </table>

    <p><strong>Total Quote Amount:</strong> ₹{{ submittedQuote.quoteAmount }}</p>
  </div>
</div>


import { Component } from '@angular/core';
import { FormControl, FormGroup, FormsModule, ReactiveFormsModule, Validators } from '@angular/forms';
import { CommonModule, NgIf } from '@angular/common';
import { AlertComponent } from '../../shared/Components/alert/alert.component';
import { UserServiceService } from '../../Services/User.Service/user-service.service';
import { Router } from '@angular/router';
import { QuoteService } from '../../Services/Quote.Service/quote.service';
import { RatingService } from '../../Services/Rating.Service/rating.service';
import { Quote } from '../../shared/Models/Quote.Model';
import { QuoteCalculationDto } from '../../shared/Models/QuoteCalculationDto .Model';

@Component({
  selector: 'app-quote',
  imports: [NgIf,AlertComponent,FormsModule,ReactiveFormsModule,CommonModule],
  templateUrl: './quote.component.html',
  styleUrl: './quote.component.css',
  standalone:true,
})
export class QuoteComponent {
  constructor(
    private userService: UserServiceService,
    private router: Router,
    private quoteService: QuoteService,
    private ratingService: RatingService
  ) {}

  step = 1;
  alertMessage: string | null = null;
  alertType: 'success' | 'error' | null = null;
  submittedQuote: Quote | null = null;
  loggedInUser: any = null;

  quoteAmount: number | null = null;
  baseRate: number | null = null;
  businessTypeRate: number | null = null;
  locationRate: number | null = null;
  propertyRate: number | null = null;
  turnoverComponent: number | null = null;
  finalRate: number | null = null;

  ngOnInit(): void {
    const user = this.userService.getLoggedInUser();
    if (!user) {
      this.router.navigate(['/login']);
    } else {
      this.loggedInUser = user;
    }
  }

  quoteForm = new FormGroup({
    businessName: new FormControl('', Validators.required),
    gstNo: new FormControl('', [Validators.minLength(15), Validators.maxLength(15)]),
    annualTurnover: new FormControl('', [Validators.required, Validators.min(10000)]),
    businessType: new FormControl('Retail', Validators.required),
    propertyValue: new FormControl('', Validators.required),
    ownershipType: new FormControl('Owned', Validators.required),
    locationType: new FormControl('Urban', Validators.required),
    securitySystem: new FormControl('',Validators.required),
    previousClaims: new FormControl('',Validators.required),
    planType: new FormControl('Normal', Validators.required),
  });

  // Step navigation
  nextStep() {
    if (this.step === 1 && this.quoteForm.controls['businessName'].valid && this.quoteForm.controls['annualTurnover'].valid) {
      this.step++;
    } else if (this.step === 2 && this.quoteForm.controls['propertyValue'].valid) {
      this.step++;
    } else {
      this.alertMessage = 'Please fill in all required fields!';
      this.alertType = 'error';
    }
  }

  prevStep() {
    this.step--;
  }

  // Submit quote using backend calculation and quote services
  submitQuote() {
    if (!this.quoteForm.valid || !this.loggedInUser) {
      this.alertMessage = 'Please complete all required fields!';
      this.alertType = 'error';
      return;
    }
    console.log(this.loggedInUser);
    const formValue = this.quoteForm.value;

    const quoteDto = new QuoteCalculationDto(
      Number(formValue.annualTurnover),
      Number(formValue.propertyValue),
      formValue.ownershipType!,
      formValue.businessType!,
      formValue.locationType!,
      formValue.planType!
    );
    console.log(quoteDto);

    this.ratingService.calculateQuote(quoteDto).subscribe({
      next: (calculated) => {
        this.quoteAmount = calculated.quoteAmount;
        this.baseRate = calculated.breakdown.baseRate;
        this.businessTypeRate = calculated.breakdown.businessTypeRate;
        this.locationRate = calculated.breakdown.locationRate;
        this.propertyRate = calculated.breakdown.propertyRate;
        this.turnoverComponent = calculated.breakdown.turnoverComponent;
        this.finalRate = calculated.breakdown.finalRate;
        const newQuote: Quote = {
          // id: '', // Will be set by backend
          brokerName: this.loggedInUser.fullName,
          brokerId: this.loggedInUser.brokerId,
          businessName: formValue.businessName!,
          gstNo: formValue.gstNo!,
          annualTurnover: Number(formValue.annualTurnover),
          propertyValue: Number(formValue.propertyValue),
          ownershipType: formValue.ownershipType!,
          businessType: formValue.businessType!,
          locationType: formValue.locationType!,
          securitySystem: formValue.securitySystem!,
          previousClaims: formValue.previousClaims!,
          securityMeasures: true, // Add actual logic if needed
          planType: formValue.planType as 'Normal' | 'Gold' | 'Premium',
          quoteAmount: calculated.quoteAmount,
          status: false,
          created: new Date(),
        };
        console.log(newQuote);
        this.quoteService.createQuote(newQuote).subscribe({
          next: (response) => {
            console.log(this.quoteForm);
            this.submittedQuote = response;
            this.alertMessage = 'Quote submitted successfully!';
            this.alertType = 'success';
            this.quoteForm.reset();
            this.step = 1;
          },
          error: (err) => {
            console.log(this.quoteForm);
            this.alertMessage = 'Error submitting quote to server.';
            this.alertType = 'error';
            console.error(err);
          }
        });
      },
      error: (err) => {
        console.log(this.quoteForm);
        this.alertMessage = 'Error calculating quote from server.';
        this.alertType = 'error';
        console.error(err);
      }
    });
  }
}



now I want to update a functionlaity of quote submission form page like i want that on single submit the broker will get the quote summery first then it can review and edit the form first and can re udate the form and re review it and a seprate submit buttom should be there to submit the form to the backend  this is to let user review and then submit the form ye I got and idea for this like I have 3 forms connected to each other the third form has submit button add a forth page where all submitted details will be there and the broker can review the datails and the generated code also be there only but the details are not submitted to the backend now a submit button is there where the user can submit the quote to backend or can go back and uodate the changes the third page button should be review where quote calculation comes but not submitting the quote to backend
